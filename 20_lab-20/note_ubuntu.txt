################ Installation de Kubeadm ###################

### On master - https://v1-30.docs.kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/


### On worker


################ Création du cluster ###################


# On master


# On worker


# On master


# kubectl apply -f ${flannel_manifest}



#!/bin/bash

################ Installation de Kubeadm ###################

### Pour Ubuntu – version Kubernetes v1.32.0
### Références : https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/

# Désactivation du swap
swapoff -a
sed -i '/ swap / s/^/#/' /etc/fstab

# Chargement des modules requis
cat <<EOF | tee /etc/modules-load.d/k8s.conf
br_netfilter
EOF

modprobe br_netfilter

# Paramètres sysctl nécessaires pour le fonctionnement de Kubernetes
cat <<EOF | tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF

sysctl --system

# Mise à jour et installation des dépendances de base
apt-get update
apt-get install -y apt-transport-https ca-certificates curl gpg

# Ajout de la clé GPG du dépôt Kubernetes (Ajout de ChatGPT)
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.32/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

# Ajout du dépôt Kubernetes pour la version stable v1.32 (Ajout de ChatGPT)
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /" > /etc/apt/sources.list.d/kubernetes.list

# Mise à jour des sources
apt-get update

# Spécification explicite de la version 1.32.0-1.1 pour tous les outils
VERSION=1.32.0-1.1
apt-get install -y kubelet=${VERSION} kubeadm=${VERSION} kubectl=${VERSION}
apt-mark hold kubelet kubeadm kubectl

# Activation et démarrage de kubelet
systemctl enable --now kubelet

# Fin de l'installation de kubeadm/kubelet/kubectl pour Ubuntu
